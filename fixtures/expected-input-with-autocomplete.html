<div class="autocomplete-container">
    <ion-input
        label="form[name]"
        name="internalform[name]"
        disabled
        type="text"
        value="value"
                class="unhandled-input-with-autocomplete"
                data-ajaxUrl="https://www.example.com/ajaxCall"
        >
    </ion-input>
    <input name="form[name]" type="hidden" value="value"/>
    <div class="autocomplete-list" style="display: none"></div>
</div>
<apie-script>
  (async function (element) {
    const actualField = element.nextElementSibling;
    let currentValue = element.value;
    const autocompleteList = element.nextElementSibling.nextElementSibling;
    let currentOption = 0;

    function highlightOption() {
        for (var i = 0; i < autocompleteList.children.length; i++) {
            autocompleteList.children[i].classList.remove('highlighted');
        }
        autocompleteList.children[currentOption].classList.add('highlighted');
    }

    function selectOption() {
        autocompleteList.children[currentOption].click();
    }
    element.addEventListener('keydown', function(event) {
        if (autocompleteList.children.length === 0) {
            return;
        }
        if (event.key === 'ArrowDown') {
            // Navigate down through the options
            event.preventDefault();
            currentOption = (currentOption + 1) % autocompleteList.children.length;
            highlightOption();
        } else if (event.key === 'ArrowUp') {
            // Navigate up through the options
            event.preventDefault();
            currentOption = (currentOption - 1 + autocompleteList.children.length) % autocompleteList.children.length;
            highlightOption();
        } else if (event.key === 'Enter') {
            // Select the current option
            event.preventDefault();
            selectOption();
        }
    });

    function displayOptions(options) {
        autocompleteList.innerHTML = '';
        if (options.length === 0) {
            autocompleteList.style.display = 'none';
            return;
        }

        autocompleteList.style.display = 'block';

        options.slice(0, 6).forEach((option) => {
            var listItem = document.createElement('div');
            listItem.innerHTML = option.displayValue;
            listItem.addEventListener('click', function() {
                currentValue = option.displayValue;
                element.value = option.displayValue;
                actualField.value= option.value;
                displayOptions([]);
            });
            autocompleteList.appendChild(listItem);
        })
        highlightOption();
    }

    function fetchOptions(newValue) {
        return fetch(
            element.dataset.ajaxUrl ?? element.dataset.ajaxurl,
            {
                method: 'POST',
                body: JSON.stringify({
                    input: newValue
                }),
                headers: {
                    Accept: 'application/json',
                    'Content-Type': 'application/json'
                }
            }
        ).then((response) => {
            if (response.ok) {
                return response.json()
            }
            throw new Error('Got error response ' . response.json().details);
        });
    }

    const update = debounce(
        (newValue) => {
            fetchOptions(newValue).then(displayOptions);
        },
        250
    );
    element.addEventListener('gr-change', function (event) {
      newValue = String(event.target.value);
      if (currentValue !== newValue) {
        update(newValue);
      }
    })
    element.classList.remove('unhandled-input-with-autocomplete');
    try {
        const options = await fetchOptions(actualField.value)
        options.forEach((option) => {
            if (option.value === actualField.value) {
                element.value = actualField.displayValue;
            }
        })
    } finally {
        element.disabled = false;
    }
  }(document.querySelector('.unhandled-input-with-autocomplete')));
  </apie-script>